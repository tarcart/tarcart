<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<!-- TARCART GAS HTML SANITY CHECK v1 -->
  <meta charset="UTF-8" />
  <title>Tarcart ‚Äì Local Gas Prices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- MarkerClusterer -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js" defer></script>

  <!-- Google Maps JS -->
  <script id="gmaps-script" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt74rhQgMZZO-KONJ_JTsBTnH3hr63a7M"></script>

  <style>
    :root {
      --sidebar-width: 260px;
      --radius-md: 12px;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --accent: #2563eb;
      --accent-gradient: linear-gradient(135deg, #60a5fa, #2563eb);
      --bg-light: #f3f4f6;
      --bg-dark: #020617;
      --sidebar-bg-light: #ffffff;
      --sidebar-bg-dark: #0f172a;
      --card-bg-light: #ffffff;
      --card-bg-dark: #020617;
      --text-main-light: #0f172a;
      --text-main-dark: #e5e7eb;
      --border-subtle-light: #e5e7eb;
      --border-subtle-dark: #111827;
      --shadow-soft-light: 0 18px 45px rgba(15,23,42,0.12);
      --shadow-soft-dark: 0 18px 45px rgba(0,0,0,0.7);
      --header-height: 64px;
    }

    html[data-theme="light"] {
      color-scheme: light;
      --bg: var(--bg-light);
      --text-main: var(--text-main-light);
      --sidebar-bg: var(--sidebar-bg-light);
      --card-bg: var(--card-bg-light);
      --border-subtle: var(--border-subtle-light);
      --shadow-soft: var(--shadow-soft-light);
    }
    html[data-theme="dark"] {
      color-scheme: dark;
      --bg: var(--bg-dark);
      --text-main: var(--text-main-dark);
      --sidebar-bg: var(--sidebar-bg-dark);
      --card-bg: var(--card-bg-dark);
      --border-subtle: var(--border-subtle-dark);
      --shadow-soft: var(--shadow-soft-dark);
    }

    body {
      margin: 0;
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1e293b 0, var(--bg) 45%);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* ===== Layout ===================================================== */

    .tarcart-shell {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      width: 100%;
      height: 100vh;
    }

    /* ===== Sidebar ===================================================== */

    .tarcart-sidebar {
      background: var(--sidebar-bg);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      box-shadow: 8px 0 40px rgba(15,23,42,0.3);
      overflow-y: auto;
      position: relative;
      z-index: 10;
      border-right: 1px solid rgba(15,23,42,0.85);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 8px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, #1d4ed8, #0f172a);
      box-shadow: 0 14px 30px rgba(15,23,42,0.6);
      color: #e5e7eb;
    }
    .sidebar-logo {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #60a5fa, #2563eb);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .sidebar-title { font-size: 17px; font-weight: 700; }
    .sidebar-subtitle { opacity: 0.75; font-size: 12px; }

    /* Chips under header */
    .sidebar-chip-stack {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .sidebar-chip {
      background: #020617;
      padding: 6px 10px;
      border-radius: var(--radius-pill);
      font-size: 12px;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 24px rgba(15,23,42,0.7);
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-chip::before {
      content: "";
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .sidebar-chip:nth-child(2)::before {
      background: #eab308;
    }

    .sidebar-nav {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-nav-btn {
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 10px;
      font-size: 0.8rem;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
      box-shadow: 0 10px 22px rgba(15,23,42,0.8);
    }

    .sidebar-nav-btn:hover {
      background: #0b1120;
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(15,23,42,0.9);
    }

    .sidebar-nav-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    /* ===== Header (top-right login) ==================================== */

    .tarcart-main {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    .tarcart-header {
      height: var(--header-height);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #020617;
      border-bottom: 1px solid #1f2937;
      color: #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .header-title {
      font-size: 0.95rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ca3af;
    }
    .header-subtitle {
      opacity: 0.75;
      font-size: 0.72rem;
      color: #6b7280;
      margin-top: 2px;
    }

    .header-login-btn {
      padding: 0.4rem 1rem;
      border-radius: 999px;
      border: 1px solid #38bdf8;
      background: #0ea5e9;
      color: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
      box-shadow: 0 0 0 0 rgba(56,189,248,0.4);
    }
    .header-login-btn:hover {
      background: #0284c7;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(56,189,248,0.35);
    }
    .header-login-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    /* Scrollable content wrapper */
    .tarcart-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.2rem 1.4rem;
    }

    /* ===== Cards / Panels ============================================= */

    .tarcart-grid {
      display: grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 16px;
      min-height: 0;
    }

    @media (max-width: 960px) {
      .tarcart-shell {
        grid-template-columns: 1fr;
      }
      .tarcart-sidebar {
        order: 2;
      }
      .tarcart-main {
        order: 1;
      }
      .tarcart-grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      padding: 0.75rem !important;
      border-radius: 0.75rem !important;
      background: radial-gradient(circle at top, #0f172a, #020617 50%, #000) !important;
      border: 1px solid #1f2937 !important;
      box-shadow: 0 25px 40px rgba(15,23,42,0.8) !important;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      min-height: 0;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.25rem 0.4rem 0.35rem;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      margin-bottom: 0.2rem;
    }

    .card-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .pill-row {
      display: inline-flex;
      background: #020617;
      border-radius: 999px;
      padding: 3px;
      border: 1px solid #1f2937;
    }

    .pill-toggle {
      border: none;
      background: transparent;
      color: #9ca3af;
      border-radius: 999px;
      font-size: 0.74rem;
      padding: 4px 10px;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .pill-toggle.active {
      background: #0ea5e9;
      color: #f9fafb;
    }

    .pill-counter {
      padding: 4px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .map-shell,
    #map-container {
      width: 100%;
      height: 420px;
      border-radius: 0.65rem;
      overflow: hidden;
      border: 1px solid #1f2937 !important;
      background: #020617;
    }

    /* ===== Inputs & Buttons =========================================== */

    label {
      font-size: 0.78rem;
      color: #9ca3af;
      display: block;
      margin-bottom: 0.35rem;
    }

    .text-input,
    .select-input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 0.45rem 0.8rem;
      font-size: 0.85rem;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }

    .text-input:focus,
    .select-input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.8);
    }

    input[type="range"] {
      width: 100%;
    }

    .primary-btn,
    .secondary-btn {
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      font-size: 0.82rem;
      cursor: pointer;
      border: none;
    }

    .primary-btn {
      background: linear-gradient(to right, #0ea5e9, #22c55e);
      color: white;
      font-weight: 600;
      box-shadow: 0 18px 35px rgba(34,197,94,0.4);
      border: none;
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 10px 20px rgba(34,197,94,0.4);
    }

    .secondary-btn {
      background: #020617;
      border: 1px solid #374151;
      color: #e5e7eb;
    }

    .secondary-btn:hover {
      background: #0b1120;
    }

    .control-stack {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .control-row {
      margin-bottom: 4px;
    }

    /* ===== Station list rows ========================================= */

    .station-row .mini-map-row {
      display: flex;
      justify-content: space-between;
    }

    .station-row .mini-map-title {
      font-size: 0.7rem;
      color: #9ca3af;
    }

.price-label {
  font-weight: 500;
}

/* Regular ‚Äì blue */
.price-regular {
  color: #60a5fa;
}

/* Midgrade ‚Äì yellow */
.price-midgrade {
  color: #eab308;
}

/* Premium ‚Äì red */
.price-premium {
  color: #f97373;
}

/* Diesel ‚Äì green */
.price-diesel {
  color: #22c55e;
}


    /* ===== Modals & Toast (re-skin only, structure kept) ============== */

    .modal-card {
      background: radial-gradient(circle at top, #020617, #020617 45%, #000) !important;
      border-radius: 1rem !important;
      border: 1px solid #1f2937 !important;
      box-shadow: 0 28px 60px rgba(0,0,0,0.85) !important;
    }

    .icon-btn {
      color: #9ca3af;
    }

    #toast {
      background: #0f172a !important;
      color: #f9fafb !important;
      border-radius: 0.7rem !important;
      font-size: 0.85rem !important;
      box-shadow: 0 12px 24px rgba(0,0,0,0.7) !important;
    }
    /* Keep modal form fields fully inside the card */
.modal-card .text-input,
.modal-card .select-input {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}

/* Keep spacing uniform inside modal fields */
.modal-card .text-input,
.modal-card .select-input {
  padding-left: 12px !important;
  padding-right: 12px !important;
}

  </style>
</head>

<body>
  <div class="tarcart-shell">
    
    <!-- ============================
         SIDEBAR (Left)
    ================================ -->
    <aside class="tarcart-sidebar">

      <!-- Logo + Title -->
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="/assets/img/tarcart-logo.png" width="30" height="30" alt="Tarcart Logo" />
        </div>
        <div>
          <div class="sidebar-title">Tarcart</div>
          <div class="sidebar-subtitle">Shields Bazaar ¬∑ Ops Console</div>
        </div>
      </div>

      <!-- Chips -->
      <div class="sidebar-chip-stack">
        <div class="sidebar-chip" id="sidebar-live-data">Live data ‚Äî 0 stations</div>
        <div class="sidebar-chip">Shields is home ‚Äî North Miami Beach, FL</div>
      </div>

      <!-- NAVIGATION -->
      <nav class="sidebar-nav">

        <button class="sidebar-nav-btn" id="nav-map-view">
          üó∫Ô∏è <span>Map view</span>
        </button>

        <button class="sidebar-nav-btn" id="nav-list-view">
          üìã <span>List view</span>
        </button>

        <button class="sidebar-nav-btn" id="nav-refresh">
          üîÑ <span>Refresh data</span>
        </button>

      </nav>

    </aside>

    <!-- ============================
         MAIN CONTENT AREA (Right)
    ================================ -->
    <main class="tarcart-main">

      <!-- Header with Login button -->
      <header class="tarcart-header">
        <div>
          <div class="header-title">Tarcart Ops Console</div>
          <div class="header-subtitle">Shields &amp; Shields Bazaar ‚Ä¢ North Miami Beach, FL</div>
        </div>

        <!-- TOP-RIGHT LOGIN BUTTON -->
        <button class="header-login-btn" id="login-btn">Login</button>
      </header>

      <!-- ============================
           MAIN PAGE CONTENT
      ================================ -->
      <section class="tarcart-content">

        <div class="tarcart-grid">

          <!-- LEFT: MAP / LIST CARD -->
          <section class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Gas station map</div>
                <div class="card-subtitle">
                  Network overview ‚Ä¢ tap station markers for details
                </div>
              </div>

              <div class="pill-row">
                <button class="pill-toggle active" id="toggle-map-view">Map</button>
                <button class="pill-toggle" id="toggle-list-view">List</button>
              </div>
            </div>

            <!-- Google map container -->
            <div id="map-container"></div>

            <!-- Hidden list container -->
            <div id="stations-list" style="display:none;"></div>

          </section>


          <!-- RIGHT: FILTERS + CONTRIBUTE -->
          <section class="card">

            <div class="card-header">
              <div>
                <div class="card-title">Contribute &amp; Filter</div>
                <div class="card-subtitle">
                  Search, filter by radius, or submit updated gas prices.
                </div>
              </div>

              <span class="pill-counter">
                <span id="station-count">0</span> stations
              </span>
            </div>

            <div class="control-stack">

              <!-- Search stations -->
              <div class="control-row">
                <label for="search-input">Search stations</label>
                <input class="text-input" id="search-input" type="text" placeholder="Search by name, brand, or city..." />
              </div>

              <!-- Radius filter -->
              <div class="control-row">
                <label>Radius (<span id="radius-label">5</span> mi)</label>
                <input id="radius-input" type="range" min="1" max="25" value="5" />
              </div>

              <!-- Center on Shields -->
              <button class="primary-btn" id="btn-center-shields">‚≠ê Center on Shields</button>

              <!-- Contribute Data -->
              <div class="control-row">
                <label>Contribute Data</label>
                <button class="secondary-btn" id="btn-submit-prices" style="margin-bottom:6px;">üßæ Submit Gas Prices</button>
                <button class="secondary-btn" id="btn-suggest-station">‚ûï Suggest a New Station</button>
              </div>

            </div>

          </section>

        </div>

      </section> <!-- end page content -->

    </main> <!-- end main -->

  </div> <!-- end shell -->


  <!-- ============================================================
       LOGIN MODAL
  =============================================================== -->
  <div class="modal-backdrop" id="login-modal" style="
       display:none; position:fixed; inset:0; 
       background:rgba(15,23,42,0.78); 
       align-items:center; justify-content:center; z-index:400;">
    
    <div class="modal-card" style="
         width: 380px;
         padding: 22px 20px;">

      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="modal-title" style="font-weight:600;font-size:16px;">Login</div>
        <button id="login-modal-close" class="icon-btn" style="
                border-radius:999px;border:1px solid rgba(148,163,184,0.5);
                width:26px;height:26px;background:rgba(15,23,42,0.15);cursor:pointer;">
          ‚úï
        </button>
      </div>

      <div style="margin-top:12px;font-size:12px;opacity:0.8;">
        Enter your admin password.
      </div>

      <!-- Password Input -->
      <input id="login-password-input" type="password" placeholder="Password"
       style="margin-top:14px;width:100%;max-width:100%;padding:10px;
       border-radius:999px;border:1px solid rgba(148,163,184,0.5);
       background:#020617;color:#e5e7eb;font-size:14px;
       box-sizing:border-box;">

      <!-- Login Button -->
      <button id="login-submit-btn" class="primary-btn" style="margin-top:16px;width:100%;font-size:14px;">
        Login
      </button>

    </div>
  </div>

 
      <!-- ============================================================
       SUBMIT GAS PRICES MODAL
  =============================================================== -->
  <div
    class="modal-backdrop"
    id="price-modal"
    style="
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.78);
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
      z-index: 350;
    "
  >
    <div
      class="modal-card"
      style="
        width: 100%;
        max-width: 420px;
        margin: 0 auto;
        padding: 22px 24px;
        box-sizing: border-box;
        background: var(--card-bg);
      "
    >
      <div
        class="modal-header"
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <div>
          <div class="modal-title" style="font-size: 15px; font-weight: 600;">
            Submit Gas Prices
          </div>
          <div
            class="small-caption"
            style="opacity: 0.75; margin-top: 2px;"
          >
            Help keep the community updated.
          </div>
        </div>
        <button
          class="icon-btn"
          id="price-modal-close"
          style="
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.55);
            width: 26px;
            height: 26px;
            background: rgba(15, 23, 42, 0.1);
            cursor: pointer;
          "
        >
          ‚úï
        </button>
      </div>

      <div
        class="modal-body"
        style="
          margin-top: 12px;
          display: flex;
          flex-direction: column;
          gap: 10px;
        "
      >
        <div
          class="modal-body-col"
          style="flex: 1; min-width: 200px;"
        >
          <label class="small-caption">Choose station</label>
          <select
            id="price-station-select"
            class="select-input"
            style="margin-top: 6px;"
          ></select>
        </div>

        <div
          class="modal-body-col"
          style="flex: 1; min-width: 200px;"
        >
          <div class="control-row">
            <label class="small-caption">Regular (87)</label>
            <input
              id="price-input-87"
              class="text-input"
              type="number"
              step="0.001"
            />
          </div>

          <div class="control-row">
            <label class="small-caption">Midgrade (89)</label>
            <input
              id="price-input-89"
              class="text-input"
              type="number"
              step="0.001"
            />
          </div>

          <div class="control-row">
            <label class="small-caption">Premium (93)</label>
            <input
              id="price-input-93"
              class="text-input"
              type="number"
              step="0.001"
            />
          </div>

          <div class="control-row">
            <label class="small-caption">Diesel</label>
            <input
              id="price-input-diesel"
              class="text-input"
              type="number"
              step="0.001"
            />
          </div>

          <div class="control-row">
            <label class="small-caption">Submitted by (optional)</label>
            <input
              id="price-submitter-name"
              class="text-input"
              type="text"
              placeholder="Your name"
            />
          </div>

          <div class="control-row">
            <label class="small-caption">Notes (optional)</label>
            <input
              id="price-notes"
              class="text-input"
              type="text"
              placeholder="Anything else to add?"
            />
          </div>
        </div>
      </div>

      <div
        class="modal-actions"
        style="
          margin-top: 14px;
          display: flex;
          justify-content: flex-end;
          gap: 8px;
        "
      >
        <button class="secondary-btn" id="price-clear-btn">Clear</button>
        <button class="primary-btn" id="price-submit-btn">Submit</button>
      </div>
    </div>
  </div>


    <!-- ============================================================
       SUGGEST NEW STATION MODAL
  =============================================================== -->
  <div
  class="modal-backdrop"
  id="suggest-modal"
  style="
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.78);
    align-items: center;
    justify-content: center;
    padding: 16px;
    box-sizing: border-box;
    z-index: 350;
  "
>

    <div
  class="modal-card"
  style="
    width: 100%;
    max-width: 420px;
    margin: 0 auto;
    padding: 22px 24px;
    box-sizing: border-box;
    background: var(--card-bg);
  "
>

      <div
        class="modal-header"
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <div>
          <div class="modal-title" style="font-size: 15px; font-weight: 600;">
            Suggest a New Station
          </div>
          <div
            class="small-caption"
            style="opacity: 0.75; margin-top: 2px;"
          >
            Add a station not currently shown in Tarcart.
          </div>
        </div>
        <button
          class="icon-btn"
          id="suggest-modal-close"
          style="
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.55);
            width: 26px;
            height: 26px;
            background: rgba(15, 23, 42, 0.1);
            cursor: pointer;
          "
        >
          ‚úï
        </button>
      </div>

      <div
  class="modal-body"
  style="
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  "
>
        <div
          class="modal-body-col"
          style="flex: 1; min-width: 220px;"
        >
          <div class="control-row">
            <label class="small-caption">Station Name</label>
            <input id="new-station-name" class="text-input" type="text" />
          </div>

          <div class="control-row">
            <label class="small-caption">Brand (optional)</label>
            <input id="new-station-brand" class="text-input" type="text" />
          </div>

          <div class="control-row">
            <label class="small-caption">Notes (optional)</label>
            <input id="new-station-notes" class="text-input" type="text" />
          </div>
        </div>

        <div
          class="modal-body-col"
          style="flex: 1; min-width: 220px;"
        >
          <div class="control-row">
            <label class="small-caption">Address</label>
            <input id="new-station-address" class="text-input" type="text" />
          </div>

          <div class="control-row">
            <label class="small-caption">City</label>
            <input id="new-station-city" class="text-input" type="text" />
          </div>

          <div class="control-row">
            <label class="small-caption">State</label>
            <input id="new-station-state" class="text-input" type="text" />
          </div>

          <div class="control-row">
            <label class="small-caption">ZIP (optional)</label>
            <input id="new-station-zip" class="text-input" type="text" />
          </div>
        </div>
      </div>

      <div
        class="modal-actions"
        style="
          margin-top: 14px;
          display: flex;
          justify-content: flex-end;
          gap: 8px;
        "
      >
        <button class="secondary-btn" id="suggest-cancel-btn">Cancel</button>
        <button class="primary-btn" id="suggest-submit-btn">Submit</button>
      </div>
    </div>
  </div>


  <!-- ============================================================
       STATION DETAILS MODAL
  =============================================================== -->
  <div class="modal-backdrop" id="station-modal" style="
       display:none; position:fixed; inset:0;
       background:rgba(15,23,42,0.72);
       align-items:center; justify-content:center; z-index:300;">

    <div class="modal-card" style="
         width: min(700px,95vw);
         max-height: 90vh;
         padding: 16px;
         display:flex;
         flex-direction:column;
         gap:10px;">

      <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div id="modal-title" class="modal-title" style="font-weight:600;font-size:15px;"></div>
          <div id="modal-subtitle" class="small-caption" style="opacity:0.8;"></div>
        </div>
        <button class="icon-btn" id="modal-close-btn" style="
                border-radius:999px;border:1px solid rgba(148,163,184,0.55);
                width:26px;height:26px;background:rgba(15,23,42,0.1);cursor:pointer;">‚úï</button>
      </div>

      <div id="full-map" style="
            width:100%;
            height:300px;
            border-radius:16px;
            border:1px solid rgba(148,163,184,0.4);
            overflow:hidden;"></div>

      <div class="modal-body" style="
            display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;font-size:12px;">
        <div class="modal-body-col" id="modal-prices" style="flex:1;min-width:200px;"></div>
        <div class="modal-body-col" id="modal-meta" style="flex:1;min-width:200px;"></div>
      </div>

      <div class="modal-actions" style="margin-top:8px;display:flex;justify-content:flex-end;gap:10px;">
        <button class="secondary-btn" id="modal-directions-btn">üß≠ Directions</button>
      </div>

    </div>
  </div>

  <!-- ============================================================
       TOAST NOTIFICATION
  =============================================================== -->
  <div id="toast" style="
        position:fixed;
        bottom:20px;
        right:20px;
        padding:10px 14px;
        display:none;
        z-index:500;">
    <span id="toast-text"></span>
  </div>


  <!-- ============================================================
       JAVASCRIPT ‚Äî CORE APP LOGIC
  =============================================================== -->
  <script>
    /*==============================================================
      BASIC STORE & CONSTANTS
    ==============================================================*/
    const TarcartStore = {
      stations: [],
      filteredStations: [],
      shieldsStation: null,
      googleReady: false,
      map: null,
      markers: [],
      markerCluster: null,
      view: "map",
      radiusMiles: 5,
      searchQuery: "",
    };

    const HOME_STATION_ID = 1;    // Shields station ID
    const SHIELDS_COORDS = { lat: 25.88951, lng: -80.16406 };
    const API_BASE = "https://octopus-app-v54dv.ondigitalocean.app";


    /*==============================================================
      TOAST MESSAGE
    ==============================================================*/
    function showToast(msg, duration = 2600) {
      const toast = document.getElementById("toast");
      const txt = document.getElementById("toast-text");
      txt.textContent = msg;
      toast.style.display = "block";
      setTimeout(() => { toast.style.display = "none"; }, duration);
    }


            /*==============================================================
      LOGIN MODAL LOGIC
    ==============================================================*/
    const loginBtn = document.getElementById("login-btn");
    const loginModal = document.getElementById("login-modal");
    const loginClose = document.getElementById("login-modal-close");
    const loginSubmit = document.getElementById("login-submit-btn");
    const loginPassword = document.getElementById("login-password-input");

    loginBtn.addEventListener("click", () => {
      loginModal.style.display = "flex";
      loginPassword.value = "";
      loginPassword.focus();
    });

    loginClose.addEventListener("click", () => {
      loginModal.style.display = "none";
    });

    loginModal.addEventListener("click", (e) => {
      if (e.target === loginModal) {
        loginModal.style.display = "none";
      }
    });

    loginSubmit.addEventListener("click", tryLogin);

    loginPassword.addEventListener("keypress", (e) => {
      if (e.key === "Enter") tryLogin();
    });

    async function tryLogin() {
      const pass = loginPassword.value.trim();
      if (!pass) {
        showToast("Please enter a password.");
        return;
      }

      loginSubmit.disabled = true;

      try {
        const res = await fetch(API_BASE + "/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password: pass })
        });

        if (!res.ok) {
          if (res.status === 401) {
            showToast("Incorrect password.");
          } else {
            showToast("Login error. Please try again.");
          }
          return;
        }

        const data = await res.json();

        if (data.token) {
          localStorage.setItem("tarcart-admin-token", data.token);
          window.location.href = "/admin.html";
        } else {
          showToast("Login error. No token returned.");
        }
      } catch (err) {
        console.error("Login failed:", err);
        showToast("Login failed. Check your connection.");
      } finally {
        loginSubmit.disabled = false;
      }
    }


    /*==============================================================
      UTILITIES
    ==============================================================*/
    function dollarsFromCents(cents) {
  if (cents == null) return "‚Äî";
  // stored as thousandths of a dollar (mills), e.g. 2870 -> $2.870
  return (cents / 1000).toFixed(3);
}

    function distanceMiles(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const toRad = (deg) => (deg * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) *
          Math.cos(toRad(lat2)) *
          Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function waitForGoogleMapsReady(cb) {
      if (window.google && window.google.maps) {
        cb();
        return;
      }
      let attempts = 0;
      const timer = setInterval(() => {
        if (window.google && window.google.maps) {
          clearInterval(timer);
          cb();
        } else if (++attempts > 40) {
          clearInterval(timer);
          console.error("Google Maps failed to load.");
        }
      }, 300);
    }
    /*==============================================================
      FETCH STATIONS FROM API
    ==============================================================*/
    async function fetchStations() {
      const res = await fetch(API_BASE + "/api/stations");
      if (!res.ok) throw new Error("Failed to load stations");
      return await res.json();
    }


    /*==============================================================
      MAP INITIALIZATION
    ==============================================================*/
    function initMap() {
      if (!TarcartStore.googleReady) return;

      const el = document.getElementById("map-container");
      TarcartStore.map = new google.maps.Map(el, {
        center: SHIELDS_COORDS,
        zoom: 12,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });
    }


    /*==============================================================
      CLEAR ALL MARKERS
    ==============================================================*/
    function clearMarkers() {
      TarcartStore.markers.forEach(m => m.setMap(null));
      TarcartStore.markers = [];

      if (TarcartStore.markerCluster) {
        TarcartStore.markerCluster.clearMarkers();
        TarcartStore.markerCluster = null;
      }
    }


    /*==============================================================
      RENDER MARKERS ON MAP
    ==============================================================*/
    function syncMapMarkers() {
      if (!TarcartStore.map) return;

      clearMarkers();

      const g = window.google;
      if (!g || !g.maps) return;

      const bounds = new g.maps.LatLngBounds();
      const stations = TarcartStore.filteredStations;
      const markers = [];

      stations.forEach(st => {
        let lat = Number(st.latitude ?? st.lat);
        let lng = Number(st.longitude ?? st.lon);

        if (!isFinite(lat) || !isFinite(lng)) {
          // fallback for Shields
          if (st.id === HOME_STATION_ID || st.is_home) {
            lat = SHIELDS_COORDS.lat;
            lng = SHIELDS_COORDS.lng;
          } else return;
        }

        const pos = { lat, lng };

        const marker = new g.maps.Marker({
          map: TarcartStore.map,
          position: pos,
          title: st.name || "Station",
          icon:
            st.id === HOME_STATION_ID || st.is_home
              ? {
                  url: "https://maps.google.com/mapfiles/kml/shapes/star.png",
                  scaledSize: new g.maps.Size(32, 32),
                }
              : undefined,
        });

        marker._station = st;

        marker.addListener("click", () => {
          openStationModal(st);
        });

        markers.push(marker);
        bounds.extend(pos);
      });

      TarcartStore.markers = markers;

      if (!bounds.isEmpty()) {
        TarcartStore.map.fitBounds(bounds);
      }

      // Cluster non-Shields
      const clustererLibrary = window.markerClusterer;
      if (clustererLibrary) {
        TarcartStore.markerCluster = new markerClusterer.MarkerClusterer({
          map: TarcartStore.map,
          markers: markers.filter(
            m => m._station.id !== HOME_STATION_ID && !m._station.is_home
          ),
        });
      }
    }


    /*==============================================================
      RENDER STATION LIST
    ==============================================================*/
    function renderStationList() {
      const container = document.getElementById("stations-list");
      container.innerHTML = "";
      const list = TarcartStore.filteredStations;

      // Update left sidebar live-data chip
      document.getElementById("sidebar-live-data").textContent =
        `Live data ‚Äî ${list.length} stations`;

      // Update right card counter
      document.getElementById("station-count").textContent = list.length;

      list.forEach(st => {
        const row = document.createElement("div");
        row.className = "station-row";
        row.style.cssText = `
          display:grid;
          grid-template-columns:1.7fr 150px;
          gap:10px;
          padding:10px;
          border-radius:16px;
          background:rgba(15,23,42,0.4);
          border:1px solid rgba(148,163,184,0.25);
          cursor:pointer;
        `;

        row.addEventListener("click", () => openStationModal(st));

        const left = document.createElement("div");
        left.className = "station-main";

        left.innerHTML = `
  <div class="station-name" style="font-size:13px;font-weight:600;">
    ${st.name || "Station"}
  </div>

  <div class="station-meta" style="font-size:11px;opacity:0.8;">
    ${st.brand ? st.brand + " ¬∑ " : ""}${st.address || ""} 
    ${st.city || ""} ${st.state || ""}
  </div>

  <!-- Distance line -->
  <div class="station-meta-row" style="font-size:11px;opacity:0.85;margin-top:3px;">
    <span>Distance ${st.distance?.toFixed(1) ?? "?"} mi</span>
  </div>

  <!-- Submitted by line -->
  <div class="station-meta-row" style="font-size:11px;opacity:0.85;margin-top:2px;">
    <span>Submitted by: ${st.is_home ? "Owner" : "Community"}</span>
  </div>
`;

        const right = document.createElement("div");
right.className = "mini-map";
right.style.cssText = `
  background:radial-gradient(circle at top,#020617,#000);
  color:#e5e7eb;
  padding:8px;
  border-radius:12px;
  border:1px solid rgba(148,163,184,0.55);
  font-size:11px;
`;

const p87 = st.prices_cents?.["87"];
const p89 = st.prices_cents?.["89"];
const p93 = st.prices_cents?.["93"];
const pd  = st.prices_cents?.["diesel"];

right.innerHTML = `
  <div class="mini-map-row">
    <span class="price-label price-regular">Regular</span>
    <span class="price-value price-regular">
      ${p87 != null ? "$" + dollarsFromCents(p87) : "‚Äî"}
    </span>
  </div>

  <div class="mini-map-row">
    <span class="price-label price-midgrade">Midgrade</span>
    <span class="price-value price-midgrade">
      ${p89 != null ? "$" + dollarsFromCents(p89) : "‚Äî"}
    </span>
  </div>

  <div class="mini-map-row">
    <span class="price-label price-premium">Premium</span>
    <span class="price-value price-premium">
      ${p93 != null ? "$" + dollarsFromCents(p93) : "‚Äî"}
    </span>
  </div>

  <div class="mini-map-row">
    <span class="price-label price-diesel">Diesel</span>
    <span class="price-value price-diesel">
      ${pd != null ? "$" + dollarsFromCents(pd) : "‚Äî"}
    </span>
  </div>
`;

        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);
      });
    }


    /*==============================================================
      STATION DETAILS MODAL
    ==============================================================*/
    let modalMap = null;

    function openStationModal(st) {
      const backdrop = document.getElementById("station-modal");
      backdrop.style.display = "flex";

      document.getElementById("modal-title").textContent = st.name || "Station";
      document.getElementById("modal-subtitle").textContent =
        `${st.address || ""} ${st.city || ""} ${st.state || ""}`;

      const p87 = st.prices_cents?.["87"];
      const p89 = st.prices_cents?.["89"];
      const p93 = st.prices_cents?.["93"];
      const pd = st.prices_cents?.["diesel"];

      document.getElementById("modal-prices").innerHTML = `
        <strong>Prices</strong><br>
        Regular (87): ${p87 ? "$"+dollarsFromCents(p87) : "‚Äî"}<br>
        Midgrade (89): ${p89 ? "$"+dollarsFromCents(p89) : "‚Äî"}<br>
        Premium (93): ${p93 ? "$"+dollarsFromCents(p93) : "‚Äî"}<br>
        Diesel: ${pd ? "$"+dollarsFromCents(pd) : "‚Äî"}<br>
      `;

      document.getElementById("modal-meta").innerHTML = `
        <strong>Details</strong><br>
        Brand: ${st.brand || "‚Äî"}<br>
        Source: ${st.is_home ? "Owner ¬∑ Shields" : "Community"}<br>
      `;

      const lat = Number(st.latitude ?? st.lat ?? SHIELDS_COORDS.lat);
      const lng = Number(st.longitude ?? st.lon ?? SHIELDS_COORDS.lng);

      modalMap = new google.maps.Map(document.getElementById("full-map"), {
        center: { lat, lng },
        zoom: 13,
        mapTypeControl: false,
        streetViewControl: false,
      });

      new google.maps.Marker({
        map: modalMap,
        position: { lat, lng },
      });

      document.getElementById("modal-directions-btn").onclick = () => {
        window.open(
          `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`,
          "_blank"
        );
      };
    }

    document.getElementById("modal-close-btn").addEventListener("click", () => {
      document.getElementById("station-modal").style.display = "none";
      modalMap = null;
    });

    document.getElementById("station-modal").addEventListener("click", (e) => {
      if (e.target.id === "station-modal") {
        document.getElementById("station-modal").style.display = "none";
      }
    });


    /*==============================================================
      SUBMIT PRICES ‚Äî LOGIC
    ==============================================================*/
    function openPriceSubmissionModal() {
  document.getElementById("price-modal").style.display = "flex";

  const select = document.getElementById("price-station-select");
  select.innerHTML = "";

  TarcartStore.stations.forEach(st => {
    const opt = document.createElement("option");
    opt.value = st.id;

    // Add street under name: "Shields Bazaar ‚Äî 12300 Biscayne Blvd"
    const street = st.address ? st.address.split(",")[0].trim() : "";
    let label = street ? `${st.name} ‚Äî ${street}` : st.name;

    if (st.id === HOME_STATION_ID || st.is_home) label += " (Shields)";

    opt.textContent = label;
    select.appendChild(opt);
  });
}

    function closePriceSubmissionModal() {
      document.getElementById("price-modal").style.display = "none";
    }

    document.getElementById("price-modal-close").addEventListener("click", closePriceSubmissionModal);
    document.getElementById("price-modal").addEventListener("click", e => {
      if (e.target.id === "price-modal") closePriceSubmissionModal();
    });

    document.getElementById("price-clear-btn").addEventListener("click", () => {
      ["87","89","93","diesel"].forEach(g => {
        document.getElementById("price-input-" + g).value = "";
      });
      document.getElementById("price-submitter-name").value = "";
      document.getElementById("price-notes").value = "";
    });

    document.getElementById("btn-submit-prices").addEventListener("click", openPriceSubmissionModal);

    document.getElementById("price-submit-btn").addEventListener("click", submitPriceSubmission);

    async function submitPriceSubmission() {
      const stationId = Number(document.getElementById("price-station-select").value);

      const submitterName = document
        .getElementById("price-submitter-name")
        .value
        .trim();

      const notes = document
        .getElementById("price-notes")
        .value
        .trim();

      const grades = ["87","89","93","diesel"];
      const submissions = [];

      grades.forEach(g => {
        const rawVal = document.getElementById("price-input-" + g).value.trim();
        if (!rawVal) return;
        const priceFloat = Number(rawVal);
        if (!Number.isFinite(priceFloat)) return;

        // store as thousandths of a dollar (e.g. 4.499 -> 4499)
        const price_cents = Math.round(priceFloat * 1000);
        submissions.push({ grade: g, price_cents });
      });

      if (!stationId || submissions.length === 0) {
        showToast("Enter at least one price.");
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/price-submissions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            station_id: stationId,
            submissions,
            submitter_name: submitterName || null,
            notes: notes || null,
            source: "gas-web",
          }),
        });

        if (!res.ok) throw new Error();

        showToast("Thanks! Prices submitted.");
        closePriceSubmissionModal();
      } catch {
        showToast("Failed to submit prices.");
      }
    }


    /*==============================================================
      SUGGEST STATION ‚Äî LOGIC
    ==============================================================*/
    function openSuggestStationModal() {
      document.getElementById("suggest-modal").style.display = "flex";
    }

    function closeSuggestStationModal() {
      document.getElementById("suggest-modal").style.display = "none";
    }

    document.getElementById("btn-suggest-station").addEventListener("click", openSuggestStationModal);
    document.getElementById("suggest-modal-close").addEventListener("click", closeSuggestStationModal);
    document.getElementById("suggest-modal").addEventListener("click", e => {
      if (e.target.id === "suggest-modal") closeSuggestStationModal();
    });

    document.getElementById("suggest-cancel-btn").addEventListener("click", closeSuggestStationModal);

    document.getElementById("suggest-submit-btn").addEventListener("click", submitSuggestStation);

    async function submitSuggestStation() {
      const payload = {
        name: document.getElementById("new-station-name").value.trim(),
        brand: document.getElementById("new-station-brand").value.trim(),
        notes: document.getElementById("new-station-notes").value.trim(),
        address: document.getElementById("new-station-address").value.trim(),
        city: document.getElementById("new-station-city").value.trim(),
        state: document.getElementById("new-station-state").value.trim(),
        postal_code: document.getElementById("new-station-zip").value.trim(),
        source: "gas-web",
      };

      if (!payload.name || !payload.city) {
        showToast("Name + City are required.");
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/price-submissions/new-station", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) throw new Error();

        showToast("Station suggestion submitted.");
        closeSuggestStationModal();
      } catch {
        showToast("Failed to submit suggestion.");
      }
    }


    /*==============================================================
      SEARCH / FILTER / RADIUS
    ==============================================================*/
    document.getElementById("search-input").addEventListener("input", e => {
      TarcartStore.searchQuery = e.target.value.toLowerCase();
      recomputeFilteredStations();
      renderStationList();
      syncMapMarkers();
    });

    document.getElementById("radius-input").addEventListener("input", e => {
      const v = Number(e.target.value);
      TarcartStore.radiusMiles = v;
      document.getElementById("radius-label").textContent = v;
      recomputeFilteredStations();
      renderStationList();
      syncMapMarkers();
    });


    function recomputeFilteredStations() {
      const q = TarcartStore.searchQuery;
      const r = TarcartStore.radiusMiles;
      const shields = TarcartStore.shieldsStation;

      const out = [];

      TarcartStore.stations.forEach(st => {
        let lat = Number(st.latitude ?? st.lat);
        let lng = Number(st.longitude ?? st.lon);

        if (!isFinite(lat) || !isFinite(lng)) {
          if (st.id === HOME_STATION_ID || st.is_home) {
            lat = SHIELDS_COORDS.lat;
            lng = SHIELDS_COORDS.lng;
          } else return;
        }

        const dist = distanceMiles(
          shields?.latitude ?? SHIELDS_COORDS.lat,
          shields?.longitude ?? SHIELDS_COORDS.lng,
          lat,
          lng
        );

        st.distance = dist;
        if (dist > r) return;

        if (q) {
          const blob = `${st.name} ${st.brand} ${st.address} ${st.city} ${st.state}`.toLowerCase();
          if (!blob.includes(q)) return;
        }

        out.push(st);
      });

      out.sort((a, b) => a.distance - b.distance);
      TarcartStore.filteredStations = out;
    }


    /*==============================================================
      VIEW SWITCHING
    ==============================================================*/
    const toggleMapBtn = document.getElementById("toggle-map-view");
    const toggleListBtn = document.getElementById("toggle-list-view");

    toggleMapBtn.addEventListener("click", () => {
      TarcartStore.view = "map";
      applyView();
    });

    toggleListBtn.addEventListener("click", () => {
      TarcartStore.view = "list";
      applyView();
      renderStationList();
    });

    document.getElementById("nav-map-view").addEventListener("click", () => {
      TarcartStore.view = "map";
      applyView();
    });

    document.getElementById("nav-list-view").addEventListener("click", () => {
      TarcartStore.view = "list";
      applyView();
      renderStationList();
    });

    function applyView() {
      const mapEl = document.getElementById("map-container");
      const listEl = document.getElementById("stations-list");

      if (TarcartStore.view === "map") {
        mapEl.style.display = "block";
        listEl.style.display = "none";
        toggleMapBtn.classList.add("active");
        toggleListBtn.classList.remove("active");
      } else {
        mapEl.style.display = "none";
        listEl.style.display = "block";
        toggleMapBtn.classList.remove("active");
        toggleListBtn.classList.add("active");
      }
    }


    /*==============================================================
      REFRESH BUTTON
    ==============================================================*/
    document.getElementById("nav-refresh").addEventListener("click", async () => {
      await loadStations();
      showToast("Data refreshed.");
    });


    /*==============================================================
      INITIAL LOAD
    ==============================================================*/
    async function loadStations() {
      try {
        const stations = await fetchStations();
        TarcartStore.stations = stations;

        // shields
        const shields = stations.find(s => s.id === HOME_STATION_ID || s.is_home);
        TarcartStore.shieldsStation = shields || {
          latitude: SHIELDS_COORDS.lat,
          longitude: SHIELDS_COORDS.lng,
        };

        recomputeFilteredStations();
        renderStationList();
        syncMapMarkers();
      } catch {
        showToast("Failed to load station data.");
      }
    }


    window.addEventListener("DOMContentLoaded", async () => {
      waitForGoogleMapsReady(() => {
        TarcartStore.googleReady = true;
        initMap();
      });

      await loadStations();
    });
  </script>

</body>
</html>
